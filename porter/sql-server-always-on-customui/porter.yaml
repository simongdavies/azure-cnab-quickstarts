name: sql-server-always-on-kubernetes-customui
version: 0.2.7
description: "SQL Server 2019 Always On for Kubernetes"
tag: cnabquickstarts.azurecr.io/porter/sql-server-always-on-kubernetes-customui/bundle:0.2.7
dockerfile: Dockerfile.tmpl

customActions:
  createdatabase:
    description: "Creates a database"
    modifies: true
    stateless: false

custom: 
  com.azure.creatuidef: 
    - name: sql_sapassword
      displayName: SQL Server Password
      displayOrder: 2
      tooltip: This is the password for the SQL sa user
      validationMessage: Password must be at least 12 characters long and contain at least one letter, one number and one of !@#$%
      validationRegex: ^((?=.*\d)(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%]).{12,})
      uitype: Microsoft.Common.PasswordBox
    - name: sql_masterkeypassword
      displayName: SQL Server Master Password
      displayOrder: 1
      validationMessage: Password must be at least 12 characters long and contain at least one letter, one number and one of !@#$%
      validationRegex: ^((?=.*\d)(?=.*[a-zA-Z])(?=.*[0-9])(?=.*[!@#$%]).{12,})
      uitype: Microsoft.Common.PasswordBox
    - name: namespace
      tooltip: This is the Kubernetes namespace that SQL Server will be created in, this namespace will be created as part of the installation
      displayName: Kubernetes Namespace for SQL Server
      uitype: Microsoft.Common.TextBox
      bladename: Kubernetes
    - name: kubeconfig
      tooltip: A Valid Kubernetes config for the Kuberentes cluster to install SQL Server in
      displayName: Kubernetes Configuration
      displayOrder: 3
      uitype: Microsoft.Common.TextBox
      bladename: Kubernetes
    - name: availabilitygroupname
      tooltip: The SQL Server Availiabity Group Name to create
      displayName: SQL Server AG Name
      displayOrder: 5
      uitype: Microsoft.Common.TextBox
      bladename: SQL Server
    - name: deploymentTime
      hide: true
    - name: cnab_installation_name
      displayOrder: 4
      tooltip: The CNAB Bundle installation name
      displayName: Installation Name
      bladename: SQL Server


credentials:
  - name: kubeconfig
    path: /root/.kube/config
    description: A Kubeconfig for the target Kubernetes Cluster
  - name: sql_sapassword
    env: SQL_SAPASSWORD
    description: The Password for the sa user in SQL Server
  - name: sql_masterkeypassword
    env: SQL_MASTERKEYPASSWORD
    description: The Password for the SQL Server Master Key

parameters:
  - name: namespace
    description: The Kuberbetes namespace to install Kubernetes into
    type: string
    applyTo:
      - install
      - upgrade
      - uninstall
  - name: availabilitygroupname
    description: The name of the SQL Server Availbility Group to create
    type: string
    default: ag1
    applyTo:
      - install
      - upgrade
      - uninstall
  - name: databasename
    description: The name of the Database to perform the action on
    type: string
    applyTo:
      - createdatabase
      - testcreatedatabase
  - name: sql_ipaddress
    description: The IP Address of the SQL Server endpoint
    type: string
    source:
      output: sql_ipaddress
    applyTo:
      - createdatabase
      - testcreatedatabase

mixins:
  - exec
  - kubernetes

install:
  - exec:
      description: Replace tokens in Yaml
      command: bash
      arguments:
        - "ssao.sh" 
        - "replace-tokens"
        - "{{ bundle.parameters.namespace }}"
        - "{{ bundle.parameters.availabilitygroupname }}"

  - kubernetes:
      description: "Create SQL Operator"
      manifests:
        - /cnab/app/manifests/sql-operator.yaml
      wait: true  

  - exec: 
      description: "Create Kubernetes Secrets"
      command: "kubectl"
      arguments: 
        - "create" 
        - "secret" 
        - "generic"         
        - "sql-secrets" 
        - "--from-literal=sapassword={{ bundle.credentials.sql_sapassword }}"
        - "--from-literal=masterkeypassword={{ bundle.credentials.sql_masterkeypassword }}"
        - "--namespace" 
        - "{{ bundle.parameters.namespace }}"
  
  - exec: 
      description: "Wait for SQL Custom Resource"
      command: "bash"
      arguments: 
        - "ssao.sh" 
        - "wait-for-sql-custom-resource"
  
  - kubernetes:
      description: "Create SQL Server"
      manifests:
        - /cnab/app/manifests/sql-server.yaml
      wait: true  
  
  - kubernetes:
      description: "Create Kubernetes Services"
      manifests:
        - /cnab/app/manifests/ag-services.yaml
      wait: true  
    
  - exec: 
      description: "Output Primary IP Address"
      command: "bash"
      arguments: 
        - "ssao.sh" 
        - "output-primary-ip-address"
        - "{{ bundle.parameters.namespace }}"        
        - "{{ bundle.parameters.availabilitygroupname }}"
      outputs:
        - name: sql_ipaddress
          path: /tmp/ipaddress

upgrade:
  - exec:
      description: Replace tokens in Yaml
      command: bash
      arguments:
        - "ssao.sh" 
        - "replace-tokens"
        - "{{ bundle.parameters.namespace }}"
        - "{{ bundle.parameters.availabilitygroupname }}"

  - kubernetes:
      description: "Update SQL Operator"
      manifests:
        - /cnab/app/manifests/sql-operator.yaml
      wait: true  
  
  - kubernetes:
      description: "Update SQL Server"
      manifests:
        - /cnab/app/manifests/sql-server.yaml
      wait: true  
  
  - kubernetes:
      description: "Update Kubernetes Services"
      manifests:
        - /cnab/app/manifests/ag-services.yaml
      wait: true  
    
  - exec: 
      description: "Output Primary IP Address"
      command: "bash"
      arguments: 
        - "ssao.sh" 
        - "output-primary-ip-address"
        - "{{ bundle.parameters.namespace }}"
        - "{{ bundle.parameters.availabilitygroupname }}"
      outputs:
        - name: sql_ipaddress
          path: /tmp/ipaddress


uninstall:
  - exec:
      description: Replace tokens in Yaml
      command: bash
      arguments:
        - "ssao.sh" 
        - "replace-tokens"
        - "{{ bundle.parameters.namespace }}"
        - "{{ bundle.parameters.availabilitygroupname }}"

  - kubernetes:
      description: "Delete SQL Server"
      manifests:
        - /cnab/app/manifests/sql-server.yaml
      wait: true  
  
  - kubernetes:
      description: "Delete Kubernetes Services"
      manifests:
        - /cnab/app/manifests/ag-services.yaml
      wait: true  

createdatabase:
  - exec:
      description: Create a Database
      command: bash
      arguments:
        - "ssao.sh" 
        - "create-database"
        - "{{ bundle.parameters.sql_ipaddress }}"
        - "sa"
        - "{{ bundle.credentials.sql_sapassword }}"
        - "{{ bundle.parameters.databasename }}"

testcreatedatabase:
  - exec:
      description: Test Create a Database
      command: bash
      arguments:
        - "ssao.sh" 
        - "test-create-database"
        - "{{ bundle.parameters.sql_ipaddress }}"
        - "sa"
        - "{{ bundle.credentials.sql_sapassword }}"
        - "{{ bundle.parameters.databasename }}"
      outputs:
        - name: testdatabaseoutput
          path: /tmp/testdatabaseoutput
      
outputs:
  - name: sql_ipaddress
    type: string
    applyTo:
      - install
      - upgrade
  - name: testdatabaseoutput
    type: string
    applyTo:
      - testcreatedatabase